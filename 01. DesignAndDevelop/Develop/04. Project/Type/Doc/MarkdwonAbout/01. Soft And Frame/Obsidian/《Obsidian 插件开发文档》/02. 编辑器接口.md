# ç¼–è¾‘å™¨æŽ¥å£

## ç¼–è¾‘å™¨æŽ¥å£

### ã€æ€»ç»“ã€‘

ä¸åŒçš„æ‰©å±•

- MarkdownåŽå¤„ç†
  - ä½¿ç”¨æ–¹æ³•ï¼š`registerMarkdownPostProcessor()`
  - è¿è¡Œæ¬¡åºï¼š**åœ¨ Markdown è¢«å¤„ç†æˆ HTML ==ä¹‹åŽ== è¿è¡Œ**
  - ä½¿ç”¨åœºæ™¯ï¼šå¦‚æžœæ‚¨æƒ³æ”¹å˜**é˜…è¯»è§†å›¾ä¸‹å¦‚ä½•å°† Markdown è½¬æ¢ä¸º HTML**ï¼Œå¯ä»¥è€ƒè™‘æž„å»ºä¸€ä¸ª [Markdown post processor](https://luhaifeng666.github.io/obsidian-plugin-docs-zh/zh2.0/editor/markdown-post-processing.html)ï¼ˆMarkdownåŽå¤„ç†å™¨ï¼‰
- ç¼–è¾‘å™¨æ‰©å±•
  - ä½¿ç”¨æ–¹æ³•ï¼š`registerEditorExtension()`
  - ä½¿ç”¨åœºæ™¯ï¼šå¦‚æžœæ‚¨æƒ³æ”¹å˜**æ–‡æ¡£åœ¨å®žæ—¶é¢„è§ˆæ—¶çš„å¤–è§‚å’Œæ„Ÿè§‰**ï¼Œæ‚¨éœ€è¦æž„å»ºä¸€ä¸ªç¼–è¾‘å™¨æ‰©å±•ã€‚åŒ…å« [View plugins](https://luhaifeng666.github.io/obsidian-plugin-docs-zh/zh2.0/editor/extensions/view-plugins.html) ä»¥åŠ [State fields](https://luhaifeng666.github.io/obsidian-plugin-docs-zh/zh2.0/editor/extensions/state-fields.html)
- è§†å›¾æ’ä»¶ï¼ˆ`CodeMirror`ç›¸å…³ï¼‰
  - ä½¿ç”¨æ–¹æ³•ï¼šéœ€è¦åˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ª [`PluginValue`](https://codemirror.net/docs/ref/#view.PluginValue) çš„ç±»ï¼Œå¹¶å°†å®ƒä¼ ç»™ [`ViewPlugin.fromClass()`](https://codemirror.net/docs/ref/#view.ViewPlugin^fromClass) æ–¹æ³•
  - è¿è¡Œæ¬¡åºï¼š**åœ¨è§†çª—è¢«é‡æ–°è®¡ç®— ==ä¹‹åŽ== è¿è¡Œ**
- çŠ¶æ€å­—æ®µ
  - ä½¿ç”¨æ–¹æ³•ï¼š`StateEffect `ä¸Ž`StateField`
  - ä½¿ç”¨åœºæ™¯ï¼šè®©æ‚¨ç®¡ç†è‡ªå®šä¹‰ç¼–è¾‘å™¨çŠ¶æ€çš„ [ç¼–è¾‘å™¨æ‰©å±•](https://luhaifeng666.github.io/obsidian-plugin-docs-zh/zh2.0/editor/extensions/)ï¼ˆä¸æ˜¯å¾ˆæ‡‚ï¼‰



å…¶ä»–è¾…åŠ©æ‰‹æ®µ

- çŠ¶æ€ç®¡ç†





### ç¼–è¾‘å™¨ `Editor`

```tsx
const view = this.app.workspace.getActiveViewOfType(MarkdownView);
const editor = view.editor;			  // æ³¨æ„è¿™é‡Œçš„thisä¸èƒ½ä¸ºplugin_thisã€‚viewçš„ç±»åž‹åˆ†åˆ«Anyå’ŒView|null
const cursor = editor.getCursor();
```

#### ç¼–è¾‘å™¨

[`Editor`](https://luhaifeng666.github.io/obsidian-plugin-docs-zh/zh2.0/reference/typescript/classes/Editor.html) ç±»é€å‡ºåœ¨ç¼–è¾‘æ¨¡å¼ä¸‹è¯»å–ä»¥åŠæ“ä½œ Markdown æ–‡æ¡£çš„æ“ä½œã€‚

å¦‚æžœæ‚¨æƒ³åœ¨å‘½ä»¤ä¸­è®¿é—®ç¼–è¾‘å™¨ï¼Œå¯ä»¥ä½¿ç”¨ [editorCallback](https://luhaifeng666.github.io/obsidian-plugin-docs-zh/zh2.0/user-interface/commands.html#editor-commands)ã€‚

å¦‚æžœæ‚¨æƒ³åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ç¼–è¾‘å™¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡ `view` è®¿é—®åˆ°å®ƒã€‚

```tsx
const view = this.app.workspace.getActiveViewOfType(MarkdownView);

// Make sure the user is editing a Markdown file.
if (view) {
  // highlight-next-line
  const cursor = view.editor.getCursor();

  // ...
}

```



> TIP
>
> Obsidian ä½¿ç”¨ [CodeMirror](https://codemirror.net/) (CM) ä½œä¸ºåº•å±‚æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œå¹¶ä¸”å°† CodeMirror ä½œä¸º API çš„ä¸€éƒ¨åˆ†æš´éœ²å‡ºæ¥ã€‚
> `Editor` ä½œä¸ºCM5ï¼ˆæ¡Œé¢ç«¯ï¼‰å’Œ CM6ï¼ˆç§»åŠ¨ç«¯ï¼‰ä¸­çš„æ¡¥æŽ¥åŠŸèƒ½è€Œè¢«æŠ½è±¡å‡ºæ¥ã€‚ä½¿ç”¨ `Editor` è€Œä¸æ˜¯ç›´æŽ¥è®¿é—® CodeMirrorï¼Œé‚£ä¹ˆæ‚¨çš„æ’ä»¶å°±å¯ä»¥åœ¨ä¸¤ä¸ªå¹³å°ä¸Šéƒ½å¯ä»¥è¿è¡Œã€‚



#### åœ¨å…‰æ ‡å¤„æ’å…¥æ–‡æœ¬

[`replaceRange()`](https://luhaifeng666.github.io/obsidian-plugin-docs-zh/zh2.0/reference/typescript/classes/Editor.html#replacerange) æ–¹æ³•ç”¨äºŽæ›¿æ¢é€‰ä¸­çš„æ–‡æœ¬ã€‚å¦‚æžœæ‚¨æ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œé‚£ä¹ˆæ–‡æœ¬å°†ä¼šåœ¨å…‰æ ‡å¤„è¢«æ’å…¥ã€‚

ä¸‹ä¾‹ä¸­çš„æŒ‡ä»¤ä¼šå°†å½“å‰æ—¥æœŸæ’å…¥å…‰æ ‡æ‰€åœ¨ä½ç½®ï¼š

```tsx
import { Editor, moment, Plugin } from "obsidian";

export default class ExamplePlugin extends Plugin {
  async onload() {
    this.addCommand({
      id: "insert-todays-date",
      name: "Insert today's date",
      editorCallback: (editor: Editor) => {
        // highlight-next-line
        editor.replaceRange(moment().format("YYYY-MM-DD"), editor.getCursor());
      },
    });
  }
}

```



#### æ›¿æ¢å½“å‰é€‰ä¸­çš„å†…å®¹

å¦‚æžœæ‚¨æƒ³ç¼–è¾‘é€‰ä¸­çš„æ–‡æœ¬ï¼Œä½¿ç”¨ [`replaceSelection()`](https://luhaifeng666.github.io/obsidian-plugin-docs-zh/zh2.0/reference/typescript/classes/Editor.html#replaceselection) æ–¹æ³•åŽ»æ›¿æ¢é€‰ä¸­çš„æ–‡æœ¬ã€‚

ä¸‹ä¾‹ä¸­çš„æŒ‡ä»¤è¯»å–å½“å‰é€‰ä¸­çš„å†…å®¹å¹¶æ›¿æ¢æˆå¤§å†™ï¼š

```tsx
import { Editor, Plugin } from "obsidian";

export default class ExamplePlugin extends Plugin {
  async onload() {
    this.addCommand({
      id: "convert-to-uppercase",
      name: "Convert to uppercase",
      editorCallback: (editor: Editor) => {
        // highlight-start
        const selection = editor.getSelection();
        editor.replaceSelection(selection.toUpperCase());
        // highlight-end
      },
    });
  }
}

```



### MarkdownåŽå¤„ç† `registerMarkdownPostProcessor()`

è‹±è¯­ï¼šè¿™é‡Œçš„postæœ‰ åœ¨â€¦â€¦ä¹‹åŽ çš„æ„æ€

#### MarkdownåŽå¤„ç†

æ‚¨çŸ¥é“ä¹ˆï¼Œæ‚¨å¯ä»¥é€šè¿‡ç±»ä¼¼ä»¥ä¸‹æ–‡æœ¬åˆ›å»º `mermaid` ä»£ç å—ï¼Œä»¥åœ¨åœ¨ Obsidian ä¸­åˆ›å»º [Mermaid](https://mermaid-js.github.io/) å›¾è¡¨ï¼Ÿ

å¦‚æžœæ‚¨æƒ³è¦æ”¹å˜ Markdown æ–‡æ¡£åœ¨**é¢„è§ˆæ¨¡å¼ä¸‹**çš„æ¸²æŸ“æ–¹å¼ï¼Œæ‚¨å¯ä»¥æ·»åŠ è‡ªå·±çš„ **Markdown åŽå¤„ç†å™¨**ã€‚
è§åçŸ¥æ„ï¼Œè¯¥åŽå¤„ç†å™¨**åœ¨ Markdown è¢«å¤„ç†æˆ HTML ==ä¹‹åŽ== è¿è¡Œ**ã€‚å®ƒå¯ä»¥è®©æ‚¨æ·»åŠ ï¼Œåˆ é™¤ï¼Œæˆ–è€…æ›¿æ¢æ¸²æŸ“åŽçš„æ–‡æ¡£ä¸­çš„[HTML å…ƒç´ ](https://luhaifeng666.github.io/obsidian-plugin-docs-zh/zh2.0/user-interface/html-elements.html)ã€‚

åŒºåˆ«

- åŽå¤„ç†å™¨ï¼š**åœ¨ Markdown è¢«å¤„ç†æˆ HTML ==ä¹‹åŽ== è¿è¡Œ**
- è§†å›¾æ’ä»¶ï¼š**åœ¨è§†çª—è¢«é‡æ–°è®¡ç®— ==ä¹‹åŽ== è¿è¡Œ**

ä¸‹ä¾‹æœç´¢åŒ…å«åœ¨ä¸¤ä¸ªå†’å· `:` ä¹‹é—´çš„å†…å®¹ï¼Œå¹¶å°†å…¶æ›¿æ¢ä¸ºæ°å½“çš„ emoji è¡¨æƒ…ï¼š

```js
import { Plugin } from "obsidian";
import { Emoji } from "./emoji";

export default class ExamplePlugin extends Plugin {
  async onload() {
    // highlight-next-line
    this.registerMarkdownPostProcessor((element, context) => {
      const codeblocks = element.querySelectorAll("code");

      for (let index = 0; index < codeblocks.length; index++) {
        const codeblock = codeblocks.item(index);
        const text = codeblock.innerText.trim();
        const isEmoji = text[0] === ":" && text[text.length - 1] === ":";

        if (isEmoji) {
          // highlight-next-line
          context.addChild(new Emoji(codeblock, text));
        }
      }
    });
  }
}

```

`Emoji` ç±»ç»§æ‰¿è‡ª [`MarkdownRenderChild`](https://luhaifeng666.github.io/obsidian-plugin-docs-zh/zh2.0/reference/typescript/classes/MarkdownRenderChild.html), å¹¶ç”¨å¸¦æœ‰è¡¨æƒ…ç¬¦å·çš„ `span` å…ƒç´ æ›¿æ¢ä»£ç å—:

```js
import { MarkdownRenderChild } from "obsidian";

// highlight-next-line
export class Emoji extends MarkdownRenderChild {
  static ALL_EMOJIS: Record<string, string> = {
    ":+1:": "ðŸ‘",
    ":sunglasses:": "ðŸ˜Ž",
    ":smile:": "ðŸ˜„",
  };

  text: string;

  constructor(containerEl: HTMLElement, text: string) {
    super(containerEl);

    this.text = text;
  }

  onload() {
    // highlight-start
    const emojiEl = this.containerEl.createSpan({
      text: Emoji.ALL_EMOJIS[this.text] ?? this.text,
    });
    this.containerEl.replaceWith(emojiEl);
    // highlight-end
  }
}

```



#### åŽå¤„ç† Markdown ä»£ç å—

æ‚¨çŸ¥é“ä¹ˆï¼Œæ‚¨å¯ä»¥é€šè¿‡ç±»ä¼¼ä»¥ä¸‹æ–‡æœ¬åˆ›å»º `mermaid` ä»£ç å—ï¼Œä»¥åœ¨åœ¨ Obsidian ä¸­åˆ›å»º [Mermaid](https://mermaid-js.github.io/) å›¾è¡¨ï¼Ÿ

~~~md
```mermaid
flowchart LR
    Start --> Stop
```
~~~

å¦‚æžœæ›´æ”¹ä¸ºé¢„è§ˆæ¨¡å¼ï¼Œä»£ç å—ä¸­çš„æ–‡æœ¬å˜ä¸ºä¸‹å›¾ï¼š

ã€Mermaidæ•ˆæžœã€‘

å¦‚æžœæ‚¨æƒ³æ·»åŠ è‡ªå·±çš„ç±»ä¼¼ä»¥ä¸‹ Mermaid çš„è‡ªå®šä¹‰ä»£ç å—ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [`registerMarkdownCodeBlockProcessor`](https://luhaifeng666.github.io/obsidian-plugin-docs-zh/zh2.0/reference/typescript/classes/Plugin_2.html#registermarkdowncodeblockprocessor)ã€‚
ä»¥ä¸‹ç¤ºä¾‹**å°†åŒ…å« CSV æ•°æ®çš„ä»£ç å—å‘ˆçŽ°ä¸ºè¡¨æ ¼**

```js
import { Plugin } from "obsidian";

export default class ExamplePlugin extends Plugin {
  async onload() {
    this.registerMarkdownCodeBlockProcessor("csv", (source, el, ctx) => { // registerMarkdownCodeBlockProcessor
      const rows = source.split("\n").filter((row) => row.length > 0);

      const table = el.createEl("table");
      const body = table.createEl("tbody");

      for (let i = 0; i < rows.length; i++) {
        const cols = rows[i].split(",");

        const row = body.createEl("tr");

        for (let j = 0; j < cols.length; j++) {
          row.createEl("td", { text: cols[j] });
        }
      }
    });
  }
}

```

