# 拦截器

```python
from nonebot import get_plugin_config
from nonebot.plugin import PluginMetadata

from .config import Config

__plugin_meta__ = PluginMetadata(
    name="blocker",
    description="拦截器/别名器。最高优先级，静态/动态拦截插件 (相当于开关插件) 以及增加别名",
    usage="暂静态生效，等待开发动态功能",
    config=Config,
)

config = get_plugin_config(Config)

"""
# 一开始用的stop_propagation方案。缺点：默认优先级好像是1，同优先级无法拦截。社区插件和内置插件基本不可拦截
# 所以后面弃用了，换用钩子函数进行拦截

from nonebot import get_driver, logger
from nonebot import on_message
from nonebot.adapters.onebot.v11 import Bot, MessageEvent
from nonebot.matcher import Matcher

superusers = set(map(str, get_driver().config.superusers)) # 超级用户列表

m = on_message(priority=1, block=False)

@m.handle()
async def fn(event: MessageEvent, matcher: Matcher):
    logger.info(f'superusers:{superusers}, user_id:{event.user_id}, isBlock:{str(event.user_id) not in superusers}') # 03-12 18:41:26 [INFO] blocker | superusers:{'762699299'}, user_id:762699299, ret:True
    if (str(event.user_id) not in superusers):
        matcher.stop_propagation()
"""

from nonebot import get_driver, logger
from nonebot.exception import IgnoredException
from nonebot.message import event_preprocessor
from nonebot.adapters import Event
from nonebot.adapters.onebot.v11 import MessageEvent

superusers = set(map(str, get_driver().config.superusers)) # 超级用户列表


@event_preprocessor
async def do_something(event: Event):
    # 拦截所有非艾特自己的信息
    # if not event.is_tome(): raise IgnoredException("some reason1")

    # 拦截所有非超管发言
    # if hasattr(event, 'user_id'):
    user_id = getattr(event, 'user_id', None)
    if user_id is not None and str(user_id) not in superusers:
        # logger.info(f'拦截, {user_id}, {event.user_id}, {event.get_user_id}')
        raise IgnoredException("some reason2")
```


