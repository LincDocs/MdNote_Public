import{_ as s,c as a,f as n,o as l}from"./app-DJfUzywl.js";const e={};function h(t,i){return l(),a("div",null,i[0]||(i[0]=[n(`<h1 id="ebpf" tabindex="-1"><a class="header-anchor" href="#ebpf"><span>eBPF</span></a></h1><h1 id="目录" tabindex="-1"><a class="header-anchor" href="#目录"><span>目录</span></a></h1><h1 id="bpf-环境搭建" tabindex="-1"><a class="header-anchor" href="#bpf-环境搭建"><span>BPF 环境搭建</span></a></h1><h2 id="系统环境准备" tabindex="-1"><a class="header-anchor" href="#系统环境准备"><span>系统环境准备</span></a></h2><h3 id="内核版本选择" tabindex="-1"><a class="header-anchor" href="#内核版本选择"><span>内核版本选择</span></a></h3><ul><li><p><strong>补丁 Prepatch</strong></p><p>Prepatch 或 “RC” 内核是主线内核的预发布版本，主要针对其他内核开发者和 Linux 爱好者。它们必须从源码中编译，并且通常包含新的功能，这些功能必须在稳定发布之前进行测试。Prepatch 内核由 Linus Torvalds 维护和发布。</p></li><li><p><strong>主线版 Mainline</strong></p><p>主线版本由 Linus Torvalds 维护。它是介绍所有新功能的版本，包含了所有令人兴奋的新开发的功能。新的主线内核每 2-3 个月发布一次。</p></li><li><p><strong>稳定版 Stable</strong></p><p>每一个主线内核发布后，它都被认为是 “稳定的”。任何稳定内核的错误修复都会从主线版本上回溯，并由指定的稳定内核维护者应用。在下一个主线内核可用之前，通常只有几个错误修复内核的发布 – 除非它被指定为 “长期维护内核”。稳定的内核更新是根据需要发布的，通常一周一次。</p></li><li><p><strong>长期版 Longterm</strong></p><p>通常会有几个 “长期维护 “的内核版本，目的是为旧内核树的错误进行后向（backporting）修正。只有重要的bug 修复才会被应用到这长期内核版本中，而且它们通常不会频繁发布，尤其是对于老的内核版本。</p></li></ul><p>当前长期版本如下：</p><table><thead><tr><th>Version</th><th>Maintainer</th><th>Released</th><th>Projected EOL</th></tr></thead><tbody><tr><td>5.4</td><td>Greg Kroah-Hartman &amp; Sasha Levin</td><td>2019-11-24</td><td>Dec, 2025</td></tr><tr><td>4.19</td><td>Greg Kroah-Hartman &amp; Sasha Levin</td><td>2018-10-22</td><td>Dec, 2024</td></tr><tr><td>4.14</td><td>Greg Kroah-Hartman &amp; Sasha Levin</td><td>2017-11-12</td><td>Jan, 2024</td></tr><tr><td>4.9</td><td>Greg Kroah-Hartman &amp; Sasha Levin</td><td>2016-12-11</td><td>Jan, 2023</td></tr><tr><td>4.4</td><td>Greg Kroah-Hartman &amp; Sasha Levin</td><td>2016-01-10</td><td>Feb, 2022</td></tr></tbody></table><p>基于上述内核版本信息，我们选择最新 LTS 版本 5.4，5.4 版本最新版本为 5.4.75。</p><h3 id="ubuntu-20-04-搭建-virtualbox-vagrant" tabindex="-1"><a class="header-anchor" href="#ubuntu-20-04-搭建-virtualbox-vagrant"><span>Ubuntu 20.04 搭建 - VirtualBox + Vagrant</span></a></h3><p>本文的操作环境基于 VirtualBox + Vagrant 搭建，你需要提前安装好 <a href="https://www.virtualbox.org/" target="_blank" rel="noopener noreferrer">VirtualBox</a> 和 <a href="https://www.vagrantup.com/" target="_blank" rel="noopener noreferrer">Vagrant</a>，操作系统采用 Ubuntun 20.04 Focal Fossa，其内核版本为 5.4.0， Ubuntu 的完整发行版本列表参见：<a href="https://zh.wikipedia.org/wiki/Ubuntu%E5%8F%91%E8%A1%8C%E7%89%88%E5%88%97%E8%A1%A8" target="_blank" rel="noopener noreferrer">wikipedia</a>。</p><table><thead><tr><th>版本</th><th>开发代号</th><th>发布日期</th><th>标准支持结束时间</th><th>延迟支持时间</th><th>内核版本</th></tr></thead><tbody><tr><td>20.04 LTS</td><td>Focal Fossa</td><td>2020-04-23</td><td><strong>2025-04</strong></td><td><strong>2030-04</strong></td><td>5.4</td></tr></tbody></table><p>采用 vagrant 安装命令如下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> vagrant</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> init</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bento/ubuntu-20.04</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> vagrant</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> vagrant</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ssh</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/issue</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # 查看发行版本</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Ubuntu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 20.04.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> LTS</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\n</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\l</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> lsb_release</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -a</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">No</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> LSB</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> modules</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> are</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> available.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Distributor</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ID:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	Ubuntu</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Description:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	Ubuntu</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 20.04.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> LTS</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Release:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">	20.04</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Codename:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">	focal</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uname</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -rs</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Linux</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 5.4.0-52-generic</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> uname</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -a</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Linux</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> vagrant</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 5.4.0-52-generic</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> #57-Ubuntu SMP Thu Oct 15 10:57:00 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dpkg</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --get-selections</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> |</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">grep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-image</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">linux-image-5.4.0-52-generic</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">			install</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">linux-image-generic</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">				install</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="内核升级方式【备选资料】" tabindex="-1"><a class="header-anchor" href="#内核升级方式【备选资料】"><span>内核升级方式【备选资料】</span></a></h3><ul><li><p>到 Ubuntu 网站 http://kernel.ubuntu.com/~kernel-ppa/mainline/</p></li><li><p>选择所需要的 Ubuntu 内核版本目录，比如最新的内核版本 <a href="https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.4.75/" target="_blank" rel="noopener noreferrer">v5.4.75 目录</a>（发布日期 2020 年 11 月 05 日）</p></li><li><p>在介绍页面中，根据硬件的架构选择内核版本，X86 硬件架构 64 位操作系统应选择 AMD64</p></li><li><p>下载对应的 deb 包</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> wget</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.4.75/amd64/linux-headers-5.4.75-050475-generic_5.4.75-050475.202011051231_amd64.deb</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> wget</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.4.75/amd64/linux-image-unsigned-5.4.75-050475-generic_5.4.75-050475.202011051231_amd64.deb</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> wget</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.4.75/amd64/linux-modules-5.4.75-050475-generic_5.4.75-050475.202011051231_amd64.deb</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ls</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -hl</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">total</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 59M</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1.2M</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Nov</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 12:51</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-headers-5.4.75-050475-generic_5.4.75-050475.202011051231_amd64.deb</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 8.5M</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Nov</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 12:50</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-image-unsigned-5.4.75-050475-generic_5.4.75-050475.202011051231_amd64.deb</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  50M</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Nov</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 12:50</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-modules-5.4.75-050475-generic_5.4.75-050475.202011051231_amd64.deb</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>安装新的内核</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dpkg</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -i</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> *</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">.deb</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>升级完成后，重启系统，再次检查内核版本，检查已经为最新的 5.4.75 版本。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># uname -sr</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Linux</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 5.4.75-050475-generic</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="系统安装包准备-包括bpf组件" tabindex="-1"><a class="header-anchor" href="#系统安装包准备-包括bpf组件"><span>系统安装包准备（包括BPF组件）</span></a></h2><p>在操作系统环境准备好以后，我们需要安装 BPF 技术测试的必要系统组件，安装命令如下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> update</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> build-essential</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> git</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> make</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> libelf-dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> clang</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> llvm</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> strace</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tar</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bpfcc-tools</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-headers-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">uname</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -r</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">gcc-multilib</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  flex</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  bison</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> libssl-dev</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -y</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>笔记者：这里分解一下需要安装的东西</p><ul><li>build-essential： 这是一个可以在 Ubuntu 上构建软件的元包。它包含了编译软件时所需的大量工具和库文件。</li><li>git： 这是一个版本控制工具，它用于管理代码版本，你也可以使用其他版本控制工具。</li><li>make： 这是用于自动执行编译工作流程的工具。</li><li>libelf-dev： 这是一个管理 ELF 文件格式的库文件，ELF 是 Linux 可执行文件的一种标准格式。</li><li>clang： 这是一种用于编译 C、C++ 和 Objective-C 的编译器，通常比 GCC 更快。</li><li>llvm： 这是一个编译基础设施，它可以将高级语言翻译成低级语言（如汇编语言）。</li><li>strace： 这是一个用于监视系统调用和信号的命令行工具。</li><li>tar： 这是一个用于归档和解压缩文件的工具。</li><li>bpfcc-tools： 这是一个用于开发 BPF 工具和程序的一组工具包。</li><li>linux-headers-$(uname -r)： 这个包包含了用于编译内核模块的头文件，其中 <code>$(uname -r)</code> 会自动获取当前正在使用的内核版本号。</li><li>gcc-multilib： 这是 GCC 版本控制工具的一个补充包，用于针对不同的体系结构生成目标代码。</li><li>flex： 这是一个用于生成词法分析器的工具。</li><li>bison： 这是一个用于生成语法分析器的工具。</li><li>libssl-dev： 这是一个管理 SSL/TLS 加密库文件的库文件，开发人员可以使用它为软件加入对 SSL/TLS 的支持。</li></ul><h2 id="内核源码编译" tabindex="-1"><a class="header-anchor" href="#内核源码编译"><span>内核源码编译</span></a></h2><h3 id="apt-安装源码-二选一-推荐" tabindex="-1"><a class="header-anchor" href="#apt-安装源码-二选一-推荐"><span>apt 安装源码 （二选一，推荐）</span></a></h3><p>一般情况下推荐采用 apt 方式的安装源码，安装简单而且只安装当前内核的源码，源码的大小在 <strong>200M</strong> 左右</p><p>下载源码</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 编译内核需要的依赖包</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt-get</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> build-essential</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> libncurses-dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bison</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> flex</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> libssl-dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> libelf-dev</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt-cache</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> search</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-source</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">linux-source</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Linux</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> source</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Ubuntu</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> patches</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">linux-source-5.4.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Linux</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> source</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> version</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5.4.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Ubuntu</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> patches</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">linux-hwe-5.8-source-5.8.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Linux</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> source</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> version</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5.8.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Ubuntu</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> patches</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-source-5.4.0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Reading</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> package</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> lists...</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Done</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Building</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dependency</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tree</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Reading</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> state</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> information...</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Done</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Suggested</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packages:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  kernel-package</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> libqt3-dev</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">The</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> following</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> NEW</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> packages</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> will</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> be</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> installed:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  linux-source-5.4.0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> upgraded,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> newly</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> installed,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> remove</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> and</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 38</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> not</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> upgraded.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Need</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> get</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 135</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> MB</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> of</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> archives.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">After</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> this</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> operation,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 150</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> MB</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> of</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> additional</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> disk</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> space</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> will</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> be</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> used.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Get:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> http://archive.ubuntu.com/ubuntu</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> focal-updates/main</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> amd64</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-source-5.4.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> all</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 5.4.0-52.57</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [135 </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">MB]</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Fetched</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 135</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> MB</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> in</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 27s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (5,015 </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">kB/s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Selecting</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> previously</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> unselected</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> package</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-source-5.4.0.</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Reading</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> database</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ...</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 81402</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> files</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> and</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> directories</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> currently</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> installed.</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Preparing</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> unpack</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> .../linux-source-5.4.0_5.4.0-52.57_all.deb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Unpacking</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-source-5.4.0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (5.4.0-52.57) ...</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Setting</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-source-5.4.0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (5.4.0-52.57) ...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>安装源码</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/src</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # 源码安装至 \`/usr/src/\` 目录下</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ls</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -hl</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">total</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 4.0K</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">drwxr-xr-x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 4.0K</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Nov</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 13:22</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-source-5.4.0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lrwxrwxrwx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">   45</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Oct</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 15</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10:28</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-source-5.4.0.tar.bz2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> -&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">linux-source-5.4.0/linux-source-5.4.0.tar.bz2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tar</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -jxvf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-source-5.4.0.tar.bz2</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> linux-source-5.4.0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> make</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scripts</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     # 构建 Linux 内核所需的一些辅助工具和脚本</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -v</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /boot/config-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">uname</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -r</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">.config</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # 确保新编译的内核与当前正在使用的内核具有相同的配置。make defconfig 或者 make menuconfig</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> make</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> headers_install</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> # 安装内核头文件到 /usr/include 目录中</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> make</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> M=samples/bpf</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 编译 BPF 样例程序。如果配置出错，可以使用 make oldconfig &amp;&amp; make prepare 修复（生成新内核的配置文件）</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="内核代码-git-下载-二选一" tabindex="-1"><a class="header-anchor" href="#内核代码-git-下载-二选一"><span>内核代码 Git 下载（二选一）</span></a></h3><p><strong>如果我们的学习过程中需要持续用到多个版本</strong>，那么可以从 Ubuntun 官方维护的 git 仓库下载整个仓库包，下载的源码大小在 <strong>3G</strong> 左右。</p><p>Ubuntun 内核代码安装教程参见：<a href="https://wiki.ubuntu.com/Kernel/Dev/KernelGitGuide" target="_blank" rel="noopener noreferrer">KernelGitGuide</a>。在线内核版本参见<a href="https://elixir.bootlin.com/linux/v5.4/source/samples/bpf" target="_blank" rel="noopener noreferrer">这里</a>，编译前可以先阅读 <a href="https://elixir.bootlin.com/linux/v5.4/source/samples/bpf/README.rst" target="_blank" rel="noopener noreferrer">README.rst</a>。</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> lsb_release</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -cs</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">focal</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> git</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> clone</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">$(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lsb_release</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -cs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 源码下载完成后，通常为 master 分支，我们可以切换到我们系统的本地版本号</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /proc/version_signature</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Ubuntu</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 5.4.0-52.57-generic</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5.4.65</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> git</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> checkout</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -b</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> temp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Ubuntu-5.4.0-52.57</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 如果后续不需要可以通过 git branch -d temp 删除</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> git</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> log</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">commit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 3f9bcec55a41c263d2f43a7ebbd8256b85767fe5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (HEAD -&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">temp,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> tag:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Ubuntu-5.4.0-52.57,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> origin/master,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> origin/HEAD,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> master</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Author:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Stefan</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Bader</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">stefan.bader@canonical.co</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">m&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Date:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   Thu</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Oct</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 15</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 12:28:28</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2020</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> +0200</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    UBUNTU:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Ubuntu-5.4.0-52.57</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    Signed-off-by:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Stefan</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Bader</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">stefan.bader@canonical.co</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">m&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>源码下载以后，编译方式与 apt 按照的方式一致。</p><h3 id="编译错误" tabindex="-1"><a class="header-anchor" href="#编译错误"><span>编译错误</span></a></h3><h4 id="scripts-mod-modpos-报错" tabindex="-1"><a class="header-anchor" href="#scripts-mod-modpos-报错"><span>scripts/mod/modpos 报错</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  WARNING:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Symbol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> version</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dump</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ./Module.symvers</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">           is</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> missing</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">modules</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> will</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> have</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> no</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dependencies</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> and</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> modversions.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  Building</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> modules,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> stage</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 2.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  MODPOST</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> modules</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">/bin/sh:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scripts/mod/modpost:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> not</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> found</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make[1]:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [scripts/Makefile.modpost:94: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">__modpost]</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Error</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 127</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [Makefile:1670: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">modules]</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Error</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以通过 <code>make scripts </code> 来补全脚本：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> make</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> scripts</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="asm-x-h-头文件缺少" tabindex="-1"><a class="header-anchor" href="#asm-x-h-头文件缺少"><span>&quot;asm/x.h&quot; 头文件缺少</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">./include/linux/spinlock.h:60:10:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> fatal</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> error:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;asm/mmiowb.h&#39;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> not</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> found</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#include &lt;asm/mmiowb.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">         ^~~~~~~~~~~~~~</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> error</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> generated.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  CC</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      samples/bpf/syscall_nrs.s</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">In</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> included</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> from</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ./include/uapi/linux/unistd.h:8,</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                 from</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> samples/bpf/syscall_nrs.c:2:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">./arch/x86/include/asm/unistd.h:19:12:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> fatal</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> error:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> asm/unistd_64_x32.h:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> such</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> or</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> directory</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">   19</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#  include &lt;asm/unistd_64_x32.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      |            </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">^~~~~~~~~~~~~~~~~~~~~</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">compilation</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> terminated.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make[1]:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [scripts/Makefile.build:99: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">samples/bpf/syscall_nrs.s]</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Error</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [Makefile:1757: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">samples/bpf]</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Error</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过查找发现系统中的头文件有对应的文件：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> find</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -name</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mmiowb.h</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">/usr/src/linux-headers-5.4.0-52-generic/arch/x86/include/generated/asm/mmiowb.h</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/src/linux-headers-5.4.0-52-generic/arch/x86/include/generated/asm/mmiowb.h</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#include &lt;asm-generic/mmiowb.h&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 include 文件中创建 asm 目录，并将该 <code>/usr/src/linux-headers-5.4.0-52-generic/arch/x86/include/generated</code> 目下的全部文件复制到 <code>include/asm</code> 目录下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mkdir</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> include/asm</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cp</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/src/linux-headers-5.4.0-52-generic/arch/x86/include/generated/asm/</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">*</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> include/asm</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>参见： https://www.mail-archive.com/openembedded-core@lists.openembedded.org/msg127370.html</p><h4 id="generated-x-h-报错" tabindex="-1"><a class="header-anchor" href="#generated-x-h-报错"><span>&quot;generated/x.h&quot; 报错</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">./include/linux/page-flags-layout.h:6:10:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> fatal</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> error:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;generated/bounds.h&#39;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> not</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> found</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#include &lt;generated/bounds.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">         ^~~~~~~~~~~~~~~~~~~~</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">^Cmake[1]:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [samples/bpf/Makefile:286: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">samples/bpf/xdp_tx_iptunnel_kern.o]</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Interrupt</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [Makefile:1757: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">samples/bpf]</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Interrupt</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>解决方式</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> cp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -r</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/src/linux-headers-5.4.0-52-generic/include/generated/</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">*</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ./include/generated</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>关于 headers 与 headers.x.y-z-generic 的区别：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">linux-headers-5.4.0-52</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Header</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> files</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> related</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Linux</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> version</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5.4.0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">linux-headers-5.4.0-52-generic</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Linux</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> headers</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> version</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5.4.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> x86/x86_64</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="其他报错" tabindex="-1"><a class="header-anchor" href="#其他报错"><span>其他报错</span></a></h4><p>可参考 https://lore.kernel.org/lkml/20190518004639.20648-3-mcroce@redhat.com/T/</p><p>目录：</p><ol><li>samples/bpf: fix test_lru_dist build</li><li>libbpf: add missing typedef</li><li>samples/bpf: fix xdpsock_user build error</li><li>samples/bpf: fix tracex5_user build error</li><li>samples/bpf: fix hbm build error</li></ol><h4 id="评论中所说的报错" tabindex="-1"><a class="header-anchor" href="#评论中所说的报错"><span>评论中所说的报错</span></a></h4><p>如果遇到 sys/capability.h: No such file or directory 则可尝试 apt install libcap-dev</p><p>如果遇到 Cannot find a vmlinux for VMLINUX_BTF 则可尝试：make VMLINUX_BTF=/sys/kernel/btf/vmlinux M=samples/bpf</p><h4 id="笔记者遇到的报错" tabindex="-1"><a class="header-anchor" href="#笔记者遇到的报错"><span>笔记者遇到的报错</span></a></h4><p>报错：找不到vmlinux</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">samples/bpf/Makefile:369:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Cannot</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> find</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> a</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> vmlinux</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> for</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> VMLINUX_BTF</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> at</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> any</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> of</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;  /usr/src/linux-source-5.15.0/vmlinux&quot;,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> build</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> or</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> VMLINUX_BTF</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> or</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> VMLINUX_H</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> variable.</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Stop.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [Makefile:1914: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">samples/bpf]</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Error</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>这是因为未成功编译内核</p><p>方法一</p><p>编译内核</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> make</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>方法二</p><p>是显式指定 <code>vmlinux</code> 文件路径，使用原来Linux系统的 vmlinux</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">export</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> VMLINUX_BTF</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">to</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">/</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">vmlinux</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>报错2：</p><p>又是和vmlinux有关……</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make[1]:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rule</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> make</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> target</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;/path/to/vmlinux&#39;,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> needed</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> by</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;samples/bpf/vmlinux.h&#39;.</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Stop.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [Makefile:1914: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">samples/bpf]</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Error</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 或</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make[2]:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> No</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rule</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> to</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> make</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> target</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;/path/to/vmlinux&#39;,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> needed</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> by</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;/usr/src/linux-source-5.15.0/samples/bpf/vmlinux.h&#39;.</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Stop.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make[1]:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [Makefile:1914: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/usr/src/linux-source-5.15.0/samples/bpf]</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Error</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make[1]:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Leaving</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> directory</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;/usr/src/linux-source-5.15.0&#39;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make:</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ***</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [Makefile:275: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">all]</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Error</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ample-bpf-样例" tabindex="-1"><a class="header-anchor" href="#ample-bpf-样例"><span>ample/bpf 样例</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> make</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> M=samples/bpf</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 清理</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">$</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> make</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> M=samples/bpf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> clean</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="hello-bpf" tabindex="-1"><a class="header-anchor" href="#hello-bpf"><span>&quot;Hello BPF&quot;</span></a></h2><p>内核中的程序 <code>hello_kern.c</code>：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#include &lt;linux/bpf.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#include &quot;bpf_helpers.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#define SEC(NAME) __attribute__((section(NAME), used))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">SEC(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&quot;tracepoint/syscalls/sys_enter_execve&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">int</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bpf_prog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">void</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> *</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ctx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	char</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> msg[]</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Hello BPF!\\n&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	bpf_trace_printk(msg,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> sizeof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">msg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">char</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> _license[]</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> SEC</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&quot;license&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;GPL&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用户态的程序 <code>hello_user.c</code>:</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#include &lt;stdio.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#include &quot;bpf_load.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">int</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">int</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> argc,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> char</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> **</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">argv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	if(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> load_bpf_file</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&quot;hello_kern.o&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	{</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">		printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&quot;The kernel didn&#39;t load BPF program\\n&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">	read_trace_pipe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在对应的位置修改 Makefile 文件，添加以下三行：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hostprogs-y</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> +=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> hello</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hello-objs</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> :=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bpf_load.o</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> hello_user.o</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">always</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> +=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> hello_kern.o</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># V=1 查看详细编译输出</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># make M=samples/bpf V=1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>编译后的效果</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ls -hl samples/bpf/hello*</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rwxr-xr-x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 404K</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Nov</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10:01</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> samples/bpf/hello</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  296</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Nov</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 09:58</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> samples/bpf/hello_kern.c</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 3.7K</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Nov</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10:02</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> samples/bpf/hello_kern.o</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  220</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Nov</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 09:57</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> samples/bpf/hello_user.c</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 2.2K</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Nov</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 10:01</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> samples/bpf/hello_user.o</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行 <code>hello</code> 程序，在另外一个终端执行 <code>ls -hl</code>，则输出结果如下：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ./hello</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">           &lt;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">...</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">-113094</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [000] ....  8411.799754: 0: Hello BPF!</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考"><span>参考</span></a></h2><ul><li><a href="http://kroah.com/log/blog/2018/08/24/what-stable-kernel-should-i-use/" target="_blank" rel="noopener noreferrer">What Stable Kernel Should I Use?</a> 作者为 LTS 版本维护者 Greg Kroah-Hartman <a href="https://linux.cn/article-10103-1.html" target="_blank" rel="noopener noreferrer">中文</a></li><li><a href="https://www.cyberciti.biz/tips/compiling-linux-kernel-26.html" target="_blank" rel="noopener noreferrer">How to compile and install Linux Kernel 5.6.9 from source code</a></li><li><a href="https://unix.stackexchange.com/questions/585479/cant-find-the-source-of-some-asm-generated-header-files-in-linux-kernel" target="_blank" rel="noopener noreferrer">Can’t find the source of some “asm”, “generated” header files in linux kernel?</a></li><li><a href="https://cloud.tencent.com/developer/article/1644458" target="_blank" rel="noopener noreferrer">编译运行Linux内核源码中的BPF示例代码</a></li><li><a href="https://blog.csdn.net/qq_34258344/article/details/108932912" target="_blank" rel="noopener noreferrer">Ubuntu下bpf纯c程序的编写与运行</a></li><li>https://me.csdn.net/qq_34258344</li><li><a href="https://w3techs.com/technologies/history_details/os-linux/all/y" target="_blank" rel="noopener noreferrer">站点 Linux 服务器分布趋势</a></li></ul>`,88)]))}const p=s(e,[["render",h],["__file","03. BPF 环境搭建.html.vue"]]),r=JSON.parse('{"path":"/01.%20DesignAndDevelop/Develop/02.%20Theory/Computer/03.%20%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%20-%20%E4%B8%93%E9%A2%98%E6%88%96%E5%AD%90%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AD%97%E5%85%B8%E7%89%88/%E4%B8%8B%E5%B1%82%E7%9B%B8%E5%85%B3/Network/%E7%BD%91%E7%BB%9C%E5%BA%93/%E6%97%A0%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%BA%93/eBPF/%E7%8B%84%E5%8D%AB%E5%8D%8E%E5%8D%9A%E5%AE%A2/03.%20BPF%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html","title":"eBPF","lang":"zh-CN","frontmatter":{"description":"eBPF 目录 BPF 环境搭建 系统环境准备 内核版本选择 补丁 Prepatch Prepatch 或 “RC” 内核是主线内核的预发布版本，主要针对其他内核开发者和 Linux 爱好者。它们必须从源码中编译，并且通常包含新的功能，这些功能必须在稳定发布之前进行测试。Prepatch 内核由 Linus Torvalds 维护和发布。 主线版 Ma...","head":[["meta",{"property":"og:url","content":"https://LincDocs.github.io/MdNote_Public/01.%20DesignAndDevelop/Develop/02.%20Theory/Computer/03.%20%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%20-%20%E4%B8%93%E9%A2%98%E6%88%96%E5%AD%90%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AD%97%E5%85%B8%E7%89%88/%E4%B8%8B%E5%B1%82%E7%9B%B8%E5%85%B3/Network/%E7%BD%91%E7%BB%9C%E5%BA%93/%E6%97%A0%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%BA%93/eBPF/%E7%8B%84%E5%8D%AB%E5%8D%8E%E5%8D%9A%E5%AE%A2/03.%20BPF%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html"}],["meta",{"property":"og:site_name","content":"MdNote_Public"}],["meta",{"property":"og:title","content":"eBPF"}],["meta",{"property":"og:description","content":"eBPF 目录 BPF 环境搭建 系统环境准备 内核版本选择 补丁 Prepatch Prepatch 或 “RC” 内核是主线内核的预发布版本，主要针对其他内核开发者和 Linux 爱好者。它们必须从源码中编译，并且通常包含新的功能，这些功能必须在稳定发布之前进行测试。Prepatch 内核由 Linus Torvalds 维护和发布。 主线版 Ma..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-02-07T17:05:32.000Z"}],["meta",{"property":"article:modified_time","content":"2025-02-07T17:05:32.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"eBPF\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-02-07T17:05:32.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"LincDocs\\",\\"url\\":\\"https://github.com/LincDocs/MdNote_Public/\\"}]}"]]},"headers":[{"level":1,"title":"eBPF","slug":"ebpf","link":"#ebpf","children":[]},{"level":1,"title":"目录","slug":"目录","link":"#目录","children":[]},{"level":1,"title":"BPF 环境搭建","slug":"bpf-环境搭建","link":"#bpf-环境搭建","children":[{"level":2,"title":"系统环境准备","slug":"系统环境准备","link":"#系统环境准备","children":[{"level":3,"title":"内核版本选择","slug":"内核版本选择","link":"#内核版本选择","children":[]},{"level":3,"title":"Ubuntu 20.04 搭建  - VirtualBox + Vagrant","slug":"ubuntu-20-04-搭建-virtualbox-vagrant","link":"#ubuntu-20-04-搭建-virtualbox-vagrant","children":[]},{"level":3,"title":"内核升级方式【备选资料】","slug":"内核升级方式【备选资料】","link":"#内核升级方式【备选资料】","children":[]}]},{"level":2,"title":"系统安装包准备（包括BPF组件）","slug":"系统安装包准备-包括bpf组件","link":"#系统安装包准备-包括bpf组件","children":[]},{"level":2,"title":"内核源码编译","slug":"内核源码编译","link":"#内核源码编译","children":[{"level":3,"title":"apt 安装源码 （二选一，推荐）","slug":"apt-安装源码-二选一-推荐","link":"#apt-安装源码-二选一-推荐","children":[]},{"level":3,"title":"内核代码 Git 下载（二选一）","slug":"内核代码-git-下载-二选一","link":"#内核代码-git-下载-二选一","children":[]},{"level":3,"title":"编译错误","slug":"编译错误","link":"#编译错误","children":[{"level":4,"title":"scripts/mod/modpos 报错","slug":"scripts-mod-modpos-报错","link":"#scripts-mod-modpos-报错","children":[]},{"level":4,"title":"\\"asm/x.h\\" 头文件缺少","slug":"asm-x-h-头文件缺少","link":"#asm-x-h-头文件缺少","children":[]},{"level":4,"title":"\\"generated/x.h\\" 报错","slug":"generated-x-h-报错","link":"#generated-x-h-报错","children":[]},{"level":4,"title":"其他报错","slug":"其他报错","link":"#其他报错","children":[]},{"level":4,"title":"评论中所说的报错","slug":"评论中所说的报错","link":"#评论中所说的报错","children":[]},{"level":4,"title":"笔记者遇到的报错","slug":"笔记者遇到的报错","link":"#笔记者遇到的报错","children":[]}]}]},{"level":2,"title":"ample/bpf 样例","slug":"ample-bpf-样例","link":"#ample-bpf-样例","children":[]},{"level":2,"title":"\\"Hello BPF\\"","slug":"hello-bpf","link":"#hello-bpf","children":[]},{"level":2,"title":"参考","slug":"参考","link":"#参考","children":[]}]}],"git":{"createdTime":1738947932000,"updatedTime":1738947932000,"contributors":[{"name":"Linc","username":"Linc","email":"762699299@qq.com","commits":1,"url":"https://github.com/Linc"}]},"readingTime":{"minutes":9.73,"words":2919},"filePathRelative":"01. DesignAndDevelop/Develop/02. Theory/Computer/03. 计算机系统 - 专题或子系统的字典版/下层相关/Network/网络库/无协议栈库/eBPF/狄卫华博客/03. BPF 环境搭建.md","localizedDate":"2025年2月7日","excerpt":"\\n<h1>目录</h1>\\n<h1>BPF 环境搭建</h1>\\n<h2>系统环境准备</h2>\\n<h3>内核版本选择</h3>\\n<ul>\\n<li>\\n<p><strong>补丁 Prepatch</strong></p>\\n<p>Prepatch 或 “RC” 内核是主线内核的预发布版本，主要针对其他内核开发者和 Linux 爱好者。它们必须从源码中编译，并且通常包含新的功能，这些功能必须在稳定发布之前进行测试。Prepatch 内核由 Linus Torvalds 维护和发布。</p>\\n</li>\\n<li>\\n<p><strong>主线版 Mainline</strong></p>\\n<p>主线版本由 Linus Torvalds 维护。它是介绍所有新功能的版本，包含了所有令人兴奋的新开发的功能。新的主线内核每 2-3 个月发布一次。</p>\\n</li>\\n<li>\\n<p><strong>稳定版 Stable</strong></p>\\n<p>每一个主线内核发布后，它都被认为是  “稳定的”。任何稳定内核的错误修复都会从主线版本上回溯，并由指定的稳定内核维护者应用。在下一个主线内核可用之前，通常只有几个错误修复内核的发布 – 除非它被指定为 “长期维护内核”。稳定的内核更新是根据需要发布的，通常一周一次。</p>\\n</li>\\n<li>\\n<p><strong>长期版 Longterm</strong></p>\\n<p>通常会有几个 “长期维护 “的内核版本，目的是为旧内核树的错误进行后向（backporting）修正。只有重要的bug 修复才会被应用到这长期内核版本中，而且它们通常不会频繁发布，尤其是对于老的内核版本。</p>\\n</li>\\n</ul>","autoDesc":true,"bioChainData":{"outlink":[],"backlink":[],"localMap":{"nodes":[{"id":"01. DesignAndDevelop/Develop/02. Theory/Computer/03. 计算机系统 - 专题或子系统的字典版/下层相关/Network/网络库/无协议栈库/eBPF/狄卫华博客/03. BPF 环境搭建.md","value":{"title":"03. BPF 环境搭建","path":"01. DesignAndDevelop/Develop/02. Theory/Computer/03. 计算机系统 - 专题或子系统的字典版/下层相关/Network/网络库/无协议栈库/eBPF/狄卫华博客/03. BPF 环境搭建.md","outlink":[],"backlink":[]}}],"links":[]}}}');export{p as comp,r as data};
