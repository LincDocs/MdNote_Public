import{_ as s,c as a,f as h,o as n}from"./app-C1kY2qtI.js";const l={};function t(k,i){return n(),a("div",null,i[0]||(i[0]=[h(`<h1 id="流量控制-tc-traffic-control" tabindex="-1"><a class="header-anchor" href="#流量控制-tc-traffic-control"><span>流量控制 (TC, Traffic Control)</span></a></h1><h2 id="tc介绍" tabindex="-1"><a class="header-anchor" href="#tc介绍"><span>TC介绍</span></a></h2><p>流量控制（Traffic Control， tc）是Linux内核提供的流量限速、整形和策略控制机制。它以 <code>qdisc-class-filter</code> 的树形结构来实现对流量的分层控制 ：</p><p>![Traffic Control](04. 流量控制.assets/tc1.jpeg)</p><p>![Traffic Control](04. 流量控制.assets/tc2.jpeg)</p><p><code>tc</code>最佳的参考就是<a href="http://www.tldp.org/HOWTO/Traffic-Control-HOWTO/" target="_blank" rel="noopener noreferrer">Linux Traffic Control HOWTO</a>，详细介绍了tc的原理和使用方法。</p><h2 id="基本组成" tabindex="-1"><a class="header-anchor" href="#基本组成"><span>基本组成</span></a></h2><p>从上图中可以看到，tc 由三部分组成：</p><ul><li><strong>qdisc</strong>：通过队列将数据包缓存起来，用来控制网络收发的速度</li><li><strong>class</strong>：用来表示控制策略</li><li><strong>filter</strong>：用来将数据包划分到具体的控制策略中</li></ul><h3 id="qdisc" tabindex="-1"><a class="header-anchor" href="#qdisc"><span>qdisc</span></a></h3><p><code>qdisc</code>通过队列将数据包缓存起来，用来控制网络收发的速度。实际上，每个网卡都有一个关联的<code>qdisc</code>。它包括以下几种：</p><ul><li>无分类qdisc（只能应用于root队列） <ul><li><code>[p|b]fifo</code>：简单先进先出</li><li><code>pfifo_fast</code>：根据数据包的<code>tos</code>将队列划分到3个<code>band</code>，每个<code>band</code>内部先进先出</li><li><code>red</code>：<code>Random Early Detection</code>，带带宽接近限制时随机丢包，适合高带宽应用</li><li><code>sfq</code>：<code>Stochastic Fairness Queueing</code>，按照会话对流量排序并循环发送每个会话的数据包</li><li><code>tbf</code>：<code>Token Bucket Filter</code>，只允许以不超过事先设定的速率到来的数据包通过 , 但可能允许短暂突发流量朝过设定值</li></ul></li><li>有分类qdisc（可以包括多个队列） <ul><li><code>cbq</code>：<code>Class Based Queueing</code>，借助<code>EWMA</code>(<code>exponential weighted moving average</code>, 指数加权移动均值 ) 算法确认链路的闲置时间足够长 , 以达到降低链路实际带宽的目的。如果发生越限 ,<code>CBQ</code> 就会禁止发包一段时间。</li><li><code>htb</code>：<code>Hierarchy Token Bucket</code>，在<code>tbf</code>的基础上增加了分层</li><li><code>prio</code>：分类优先算法并不进行整形 , 它仅仅根据你配置的过滤器把流量进一步细分。缺省会自动创建三个<code>FIFO</code>类。</li></ul></li></ul><p>注意，<strong>一般说到qdisc都是指egress qdisc</strong>。每块网卡实际上还可以添加一个<code>ingress qdisc</code>，不过它有诸多的限制</p><ul><li><code>ingress qdisc</code>不能包含子类，而只能作过滤</li><li><code>ingress qdisc</code>只能用于简单的整形</li></ul><p>如果相对<code>ingress</code>方向作流量控制的话，可以借助<a href="https://wiki.linuxfoundation.org/networking/ifb" target="_blank" rel="noopener noreferrer">ifb（ Intermediate Functional Block）</a>内核模块。因为流入网络接口的流量是无法直接控制的，那么就需要把流入的包导入（通过 <code>tc action</code>）到一个中间的队列，该队列在 ifb 设备上，然后让这些包重走 <code>tc</code> 层，最后流入的包再重新入栈，流出的包重新出栈。</p><p>![Intermediate Funcational Block](04. 流量控制.assets/ifb.jpeg)</p><h3 id="filter" tabindex="-1"><a class="header-anchor" href="#filter"><span>filter</span></a></h3><p><code>filter</code>用来将数据包划分到具体的控制策略中，包括以下几种：</p><ul><li><code>u32</code>：根据协议、<code>IP</code>、端口等过滤数据包</li><li><code>fwmark</code>：根据<code>iptables MARK</code>来过滤数据包</li><li><code>tos</code>：根据<code>tos</code>字段过滤数据包</li></ul><h3 id="class" tabindex="-1"><a class="header-anchor" href="#class"><span>class</span></a></h3><p><code>class</code>用来表示控制策略，只用于有分类的<code>qdisc</code>上。每个<code>class</code>要么包含多个子类，要么只包含一个子<code>qdisc</code>。当然，每个<code>class</code>还包括一些列的<code>filter</code>，控制数据包流向不同的子类，或者是直接丢掉。</p><h2 id="htb示例" tabindex="-1"><a class="header-anchor" href="#htb示例"><span>htb示例</span></a></h2><p>![Simplified Linux Traffic Control Scenario with HTB](04. 流量控制.assets/htb-class.png)</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># add qdisc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> handle</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> htb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> default</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> r2q</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 100</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># add default class</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> class</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> classid</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> htb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rate</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1000mbit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ceil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1000mbit</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> class</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> classid</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> htb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rate</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1000mbit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ceil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1000mbit</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> handle</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 2:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pfifo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> limit</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 500</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># add default filter</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> filter</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> protocol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> u32</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> filter</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> handle</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 3:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> protocol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> u32</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> divisor</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 256</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> filter</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> protocol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> u32</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ht</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 800::</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> match</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> src</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.0.0/16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> hashkey</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mask</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0x000000ff</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> at</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 12</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 3:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># add egress rules for 192.168.0.9</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> class</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> classid</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> htb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rate</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 3mbit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ceil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 3mbit</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> handle</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 9:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pfifo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> limit</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 500</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> filter</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> protocol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> u32</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ht</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 3:9:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> match</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> src</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;192.168.0.9&quot;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> flowid</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:9</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ifb示例" tabindex="-1"><a class="header-anchor" href="#ifb示例"><span>ifb示例</span></a></h2><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># init ifb</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">modprobe</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> numifbs=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> up</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#  redirect ingress to ifb0</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ingress</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> handle</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ffff:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> filter</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> eth0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ffff:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> protocol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> u32</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> match</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> u32</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> flowid</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ffff:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> action</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mirred</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> egress</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> redirect</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb0</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># add qdisc</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> handle</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> htb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> default</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> r2q</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 100</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># add default class</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> class</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> classid</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> htb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rate</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1000mbit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ceil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1000mbit</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> class</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> classid</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> htb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rate</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1000mbit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ceil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1000mbit</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> handle</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 2:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pfifo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> limit</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 500</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># add default filter</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> filter</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> protocol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> u32</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> filter</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> handle</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 4:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> protocol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> u32</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> divisor</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 256</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> filter</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> protocol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> u32</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ht</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 800::</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> match</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dst</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 192.168.0.0/16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> hashkey</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mask</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0x000000ff</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> at</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> link</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 4:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># add ingress rules for 192.168.0.9</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> class</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> classid</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> htb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rate</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 3mbit</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ceil</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 3mbit</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> qdisc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> handle</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 9:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> pfifo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> limit</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 500</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tc</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> filter</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dev</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ifb0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> parent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> protocol</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> prio</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> u32</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ht</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 4:9:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> match</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ip</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> dst</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;192.168.0.9&quot;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> flowid</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1:9</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考文档" tabindex="-1"><a class="header-anchor" href="#参考文档"><span>参考文档</span></a></h2><ul><li><a href="http://www.tldp.org/HOWTO/Traffic-Control-HOWTO/" target="_blank" rel="noopener noreferrer">Linux Traffic Control HOWTO</a></li><li><a href="https://wiki.linuxfoundation.org/networking/ifb" target="_blank" rel="noopener noreferrer">ifb wiki</a></li><li><a href="http://blog.csdn.net/dog250/article/details/40483627" target="_blank" rel="noopener noreferrer">Linux TC (Traffic Control) 框架原理解析</a></li><li><a href="http://blog.csdn.net/dog250/article/details/40680765" target="_blank" rel="noopener noreferrer">Linux TC的ifb原理以及ingress流控</a></li></ul>`,28)]))}const p=s(l,[["render",t],["__file","04. 流量控制.html.vue"]]),d=JSON.parse('{"path":"/01.%20DesignAndDevelop/Develop/02.%20Theory/Computer/03.%20%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%20-%20%E4%B8%93%E9%A2%98%E6%88%96%E5%AD%90%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AD%97%E5%85%B8%E7%89%88/%E4%B8%8B%E5%B1%82%E7%9B%B8%E5%85%B3/Network/%E3%80%8Asdn-handbook%E3%80%8Btonydeng/03.%20Linux%E7%BD%91%E7%BB%9C/04.%20%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6.html","title":"流量控制 (TC, Traffic Control)","lang":"zh-CN","frontmatter":{"description":"流量控制 (TC, Traffic Control) TC介绍 流量控制（Traffic Control， tc）是Linux内核提供的流量限速、整形和策略控制机制。它以 qdisc-class-filter 的树形结构来实现对流量的分层控制 ： ![Traffic Control](04. 流量控制.assets/tc1.jpeg) ![Traffi...","head":[["meta",{"property":"og:url","content":"https://LincDocs.github.io/MdNote_Public/01.%20DesignAndDevelop/Develop/02.%20Theory/Computer/03.%20%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%20-%20%E4%B8%93%E9%A2%98%E6%88%96%E5%AD%90%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AD%97%E5%85%B8%E7%89%88/%E4%B8%8B%E5%B1%82%E7%9B%B8%E5%85%B3/Network/%E3%80%8Asdn-handbook%E3%80%8Btonydeng/03.%20Linux%E7%BD%91%E7%BB%9C/04.%20%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6.html"}],["meta",{"property":"og:site_name","content":"MdNote_Public"}],["meta",{"property":"og:title","content":"流量控制 (TC, Traffic Control)"}],["meta",{"property":"og:description","content":"流量控制 (TC, Traffic Control) TC介绍 流量控制（Traffic Control， tc）是Linux内核提供的流量限速、整形和策略控制机制。它以 qdisc-class-filter 的树形结构来实现对流量的分层控制 ： ![Traffic Control](04. 流量控制.assets/tc1.jpeg) ![Traffi..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-02-05T15:34:38.000Z"}],["meta",{"property":"article:modified_time","content":"2025-02-05T15:34:38.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"流量控制 (TC, Traffic Control)\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-02-05T15:34:38.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"LincDocs\\",\\"url\\":\\"https://github.com/LincDocs/MdNote_Public/\\"}]}"]]},"headers":[{"level":1,"title":"流量控制 (TC, Traffic Control)","slug":"流量控制-tc-traffic-control","link":"#流量控制-tc-traffic-control","children":[{"level":2,"title":"TC介绍","slug":"tc介绍","link":"#tc介绍","children":[]},{"level":2,"title":"基本组成","slug":"基本组成","link":"#基本组成","children":[{"level":3,"title":"qdisc","slug":"qdisc","link":"#qdisc","children":[]},{"level":3,"title":"filter","slug":"filter","link":"#filter","children":[]},{"level":3,"title":"class","slug":"class","link":"#class","children":[]}]},{"level":2,"title":"htb示例","slug":"htb示例","link":"#htb示例","children":[]},{"level":2,"title":"ifb示例","slug":"ifb示例","link":"#ifb示例","children":[]},{"level":2,"title":"参考文档","slug":"参考文档","link":"#参考文档","children":[]}]}],"git":{"createdTime":1738769678000,"updatedTime":1738769678000,"contributors":[{"name":"Linc","username":"Linc","email":"762699299@qq.com","commits":1,"url":"https://github.com/Linc"}]},"readingTime":{"minutes":4.26,"words":1279},"filePathRelative":"01. DesignAndDevelop/Develop/02. Theory/Computer/03. 计算机系统 - 专题或子系统的字典版/下层相关/Network/《sdn-handbook》tonydeng/03. Linux网络/04. 流量控制.md","localizedDate":"2025年2月5日","excerpt":"\\n<h2>TC介绍</h2>\\n<p>流量控制（Traffic Control， tc）是Linux内核提供的流量限速、整形和策略控制机制。它以 <code>qdisc-class-filter</code> 的树形结构来实现对流量的分层控制 ：</p>\\n<p>![Traffic Control](04. 流量控制.assets/tc1.jpeg)</p>\\n<p>![Traffic Control](04. 流量控制.assets/tc2.jpeg)</p>\\n<p><code>tc</code>最佳的参考就是<a href=\\"http://www.tldp.org/HOWTO/Traffic-Control-HOWTO/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">Linux Traffic Control HOWTO</a>，详细介绍了tc的原理和使用方法。</p>","autoDesc":true,"bioChainData":{"outlink":[],"backlink":[],"localMap":{"nodes":[{"id":"01. DesignAndDevelop/Develop/02. Theory/Computer/03. 计算机系统 - 专题或子系统的字典版/下层相关/Network/《sdn-handbook》tonydeng/03. Linux网络/04. 流量控制.md","value":{"title":"04. 流量控制","path":"01. DesignAndDevelop/Develop/02. Theory/Computer/03. 计算机系统 - 专题或子系统的字典版/下层相关/Network/《sdn-handbook》tonydeng/03. Linux网络/04. 流量控制.md","outlink":[],"backlink":[]}}],"links":[]}}}');export{p as comp,d as data};
