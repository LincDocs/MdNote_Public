import{_ as s,c as a,e as t,o as e}from"./app-Z3IVicAk.js";const o={};function p(l,n){return e(),a("div",null,n[0]||(n[0]=[t(`<h1 id="自动部署k3s集群" tabindex="-1"><a class="header-anchor" href="#自动部署k3s集群"><span>自动部署k3s集群</span></a></h1><ul><li><strong>一行命令</strong></li><li><strong>自动配置集群</strong></li><li><strong>全程无需人工干预</strong></li></ul><h3 id="_1-集群规划" tabindex="-1"><a class="header-anchor" href="#_1-集群规划"><span>1.集群规划</span></a></h3><table><thead><tr><th>主机名</th><th>IP地址</th><th>类型</th></tr></thead><tbody><tr><td>k3s-server</td><td>192.168.56.10</td><td>Control Plane 控制平面</td></tr><tr><td>k3s-agent1</td><td>192.168.56.11</td><td>工作节点</td></tr><tr><td>k3s-agent2</td><td>192.168.56.12</td><td>工作节点</td></tr></tbody></table><h3 id="_2-vagrantfile-配置文件" tabindex="-1"><a class="header-anchor" href="#_2-vagrantfile-配置文件"><span>2.Vagrantfile 配置文件</span></a></h3><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>vm_list <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> # hash map
    <span class="token string">&quot;name&quot;</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;k3s-server&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;cpu&quot;</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;mem&quot;</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;2048&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ip_addr&quot;</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;192.168.56.10&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;k3s-agent1&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;cpu&quot;</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;mem&quot;</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;1024&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ip_addr&quot;</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;192.168.56.11&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;k3s-agent2&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;cpu&quot;</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;mem&quot;</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;1024&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ip_addr&quot;</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;192.168.56.12&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

Vagrant<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token operator">|</span>config<span class="token operator">|</span>

   config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box <span class="token operator">=</span> <span class="token string">&quot;ubuntu/jammy64&quot;</span>

   vm_list<span class="token punctuation">.</span>each <span class="token keyword">do</span> <span class="token operator">|</span>item<span class="token operator">|</span>
        config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>define item<span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span> <span class="token keyword">do</span> <span class="token operator">|</span>node<span class="token operator">|</span>
            node<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token string">&quot;virtualbox&quot;</span> <span class="token keyword">do</span> <span class="token operator">|</span>vbox<span class="token operator">|</span>
              vbox<span class="token punctuation">.</span>name <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  #虚拟机名称
              vbox<span class="token punctuation">.</span>memory <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">&quot;mem&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> #内存
              vbox<span class="token punctuation">.</span>cpus <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">&quot;cpu&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   #<span class="token constant">CPU</span>
            end
            # 设置hostname
            node<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>hostname <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span>
            # 设置<span class="token constant">IP</span>
            node<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>network <span class="token string">&quot;private_network&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">ip</span><span class="token operator">:</span> item<span class="token punctuation">[</span><span class="token string">&quot;ip_addr&quot;</span><span class="token punctuation">]</span>

            # 执行shell脚本
            node<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token string">&quot;shell&quot;</span> <span class="token keyword">do</span> <span class="token operator">|</span>script<span class="token operator">|</span>
              script<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token string">&quot;k3s-install.sh&quot;</span>   #脚本路径
              script<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token punctuation">[</span> item<span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">]</span>   #传递参数
            end
        end
    end

end
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-安装脚本" tabindex="-1"><a class="header-anchor" href="#_3-安装脚本"><span>3.安装脚本</span></a></h3><p>在安装脚本中，我们通过传入的参数，也就是虚拟机的名字，来执行不同的命令。</p><h4 id="环境变量" tabindex="-1"><a class="header-anchor" href="#环境变量"><span>环境变量</span></a></h4><p>自动创建K3s集群，需要配置下面两个环境变量：</p><ul><li><code>K3S_TOKEN</code>： 预先约定好token，工作节点自动加入</li><li><code>K3S_URL</code>： 主节点API server的访问地址</li></ul><p>由于预先分配了IP，所以可以确定API server的访问地址。</p><h4 id="flannel网络" tabindex="-1"><a class="header-anchor" href="#flannel网络"><span>Flannel网络</span></a></h4><p>K3s内置了 <code>flannel</code> 作为默认的网络插件(CNI)。</p><p><code>flannel</code> 默认是选择第一个网卡进行网络通信，由于Vagrant虚拟机的第一个网卡是NAT模式，虚拟机之间无法互相访问。因此，在安装k3s时，需要使用 <code>--flannel-iface</code> 将第二个网卡 <code>enp0s8</code> 设置为默认网络。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>echo <span class="token string">&quot;==&gt; k3s cluster settings:&quot;</span>
<span class="token constant">K3S_TOKEN</span><span class="token operator">=</span>NEIwQ0IxMEUtNTA2MS00RE
<span class="token constant">K3S_URL</span><span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.10</span><span class="token operator">:</span><span class="token number">6443</span>
<span class="token constant">FLANNEL_IFACE</span><span class="token operator">=</span><span class="token string">&quot;enp0s8&quot;</span>
echo <span class="token string">&quot;    TOKEN: \${TOKEN}&quot;</span>
echo <span class="token string">&quot;    API_SERVER:\${API_SERVER}&quot;</span>
echo <span class="token string">&quot;    FLANNEL_IFACE:\${FLANNEL_IFACE}&quot;</span>

echo <span class="token string">&quot;==&gt; disable firewall&quot;</span>
ufw disable

<span class="token keyword">if</span> <span class="token punctuation">[</span> $1 <span class="token operator">==</span> <span class="token string">&quot;k3s-server&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then
    echo <span class="token string">&quot;==&gt; install $1&quot;</span>
    curl <span class="token operator">-</span>sfL https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>rancher<span class="token operator">-</span>mirror<span class="token punctuation">.</span>rancher<span class="token punctuation">.</span>cn<span class="token operator">/</span>k3s<span class="token operator">/</span>k3s<span class="token operator">-</span>install<span class="token punctuation">.</span>sh <span class="token operator">|</span> \\
         <span class="token constant">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn \\
         <span class="token constant">K3S_TOKEN</span><span class="token operator">=</span>$<span class="token punctuation">{</span><span class="token constant">TOKEN</span><span class="token punctuation">}</span> \\
         sh <span class="token operator">-</span>s <span class="token operator">-</span> server <span class="token operator">--</span>flannel<span class="token operator">-</span>iface $<span class="token punctuation">{</span><span class="token constant">FLANNEL_IFACE</span><span class="token punctuation">}</span>
<span class="token keyword">else</span>
    echo <span class="token string">&quot;==&gt; install $1&quot;</span>
    curl <span class="token operator">-</span>sfL https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>rancher<span class="token operator">-</span>mirror<span class="token punctuation">.</span>rancher<span class="token punctuation">.</span>cn<span class="token operator">/</span>k3s<span class="token operator">/</span>k3s<span class="token operator">-</span>install<span class="token punctuation">.</span>sh <span class="token operator">|</span> \\
         <span class="token constant">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn \\
         <span class="token constant">K3S_URL</span><span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">API_SERVER</span><span class="token punctuation">}</span><span class="token operator">:</span><span class="token number">6443</span> \\
         <span class="token constant">K3S_TOKEN</span><span class="token operator">=</span>$<span class="token punctuation">{</span><span class="token constant">TOKEN</span><span class="token punctuation">}</span> \\
         sh <span class="token operator">-</span>s <span class="token operator">-</span> <span class="token operator">--</span>flannel<span class="token operator">-</span>iface $<span class="token punctuation">{</span><span class="token constant">FLANNEL_IFACE</span><span class="token punctuation">}</span>
fi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="评论补充" tabindex="-1"><a class="header-anchor" href="#评论补充"><span>评论补充</span></a></h2><p>这段脚本中变量有点错误，修改后可用的：</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>echo <span class="token string">&quot;==&gt; k3s cluster settings:&quot;</span>
<span class="token constant">K3S_TOKEN</span><span class="token operator">=</span>NEIwQ0IxMEUtNTA2MS00RE
<span class="token constant">K3S_URL</span><span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.56</span><span class="token number">.10</span><span class="token operator">:</span><span class="token number">6443</span>
<span class="token constant">FLANNEL_IFACE</span><span class="token operator">=</span><span class="token string">&quot;enp0s8&quot;</span>
echo <span class="token string">&quot;    TOKEN: \${K3S_TOKEN}&quot;</span>
echo <span class="token string">&quot;    API_SERVER: \${K3S_URL}&quot;</span>
echo <span class="token string">&quot;    FLANNEL_IFACE: \${FLANNEL_IFACE}&quot;</span>

echo <span class="token string">&quot;==&gt; disable firewall&quot;</span>
ufw disable

<span class="token keyword">if</span> <span class="token punctuation">[</span> $1 <span class="token operator">==</span> <span class="token string">&quot;k3s-server&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then
    echo <span class="token string">&quot;==&gt; install $1&quot;</span>
    curl <span class="token operator">-</span>sfL https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>rancher<span class="token operator">-</span>mirror<span class="token punctuation">.</span>rancher<span class="token punctuation">.</span>cn<span class="token operator">/</span>k3s<span class="token operator">/</span>k3s<span class="token operator">-</span>install<span class="token punctuation">.</span>sh <span class="token operator">|</span> \\
         <span class="token constant">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn \\
         <span class="token constant">K3S_TOKEN</span><span class="token operator">=</span>$<span class="token punctuation">{</span><span class="token constant">K3S_TOKEN</span><span class="token punctuation">}</span> \\
         sh <span class="token operator">-</span>s <span class="token operator">-</span> server <span class="token operator">--</span>flannel<span class="token operator">-</span>iface $<span class="token punctuation">{</span><span class="token constant">FLANNEL_IFACE</span><span class="token punctuation">}</span>
<span class="token keyword">else</span>
    echo <span class="token string">&quot;==&gt; install $1&quot;</span>
    curl <span class="token operator">-</span>sfL https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>rancher<span class="token operator">-</span>mirror<span class="token punctuation">.</span>rancher<span class="token punctuation">.</span>cn<span class="token operator">/</span>k3s<span class="token operator">/</span>k3s<span class="token operator">-</span>install<span class="token punctuation">.</span>sh <span class="token operator">|</span> \\
         <span class="token constant">INSTALL_K3S_MIRROR</span><span class="token operator">=</span>cn \\
         <span class="token constant">K3S_URL</span><span class="token operator">=</span>$<span class="token punctuation">{</span><span class="token constant">K3S_URL</span><span class="token punctuation">}</span> \\
         <span class="token constant">K3S_TOKEN</span><span class="token operator">=</span>$<span class="token punctuation">{</span><span class="token constant">K3S_TOKEN</span><span class="token punctuation">}</span> \\
         sh <span class="token operator">-</span>s <span class="token operator">-</span> <span class="token operator">--</span>flannel<span class="token operator">-</span>iface $<span class="token punctuation">{</span><span class="token constant">FLANNEL_IFACE</span><span class="token punctuation">}</span>
fi
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,19)]))}const i=s(o,[["render",p],["__file","08. 自动部署k3s集群.html.vue"]]),r=JSON.parse('{"path":"/01.%20DesignAndDevelop/Virtual/%E8%99%9A%E6%8B%9F%E6%9C%BA/Vagrant/%E3%80%8AVagrant%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%8B/08.%20%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2k3s%E9%9B%86%E7%BE%A4.html","title":"自动部署k3s集群","lang":"zh-CN","frontmatter":{"description":"自动部署k3s集群 一行命令 自动配置集群 全程无需人工干预 1.集群规划 2.Vagrantfile 配置文件 3.安装脚本 在安装脚本中，我们通过传入的参数，也就是虚拟机的名字，来执行不同的命令。 环境变量 自动创建K3s集群，需要配置下面两个环境变量： K3S_TOKEN： 预先约定好token，工作节点自动加入 K3S_URL： 主节点API ...","head":[["meta",{"property":"og:url","content":"https://LincDocs.github.io/MdNote_Public/01.%20DesignAndDevelop/Virtual/%E8%99%9A%E6%8B%9F%E6%9C%BA/Vagrant/%E3%80%8AVagrant%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%8B/08.%20%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2k3s%E9%9B%86%E7%BE%A4.html"}],["meta",{"property":"og:site_name","content":"MdNote_Public"}],["meta",{"property":"og:title","content":"自动部署k3s集群"}],["meta",{"property":"og:description","content":"自动部署k3s集群 一行命令 自动配置集群 全程无需人工干预 1.集群规划 2.Vagrantfile 配置文件 3.安装脚本 在安装脚本中，我们通过传入的参数，也就是虚拟机的名字，来执行不同的命令。 环境变量 自动创建K3s集群，需要配置下面两个环境变量： K3S_TOKEN： 预先约定好token，工作节点自动加入 K3S_URL： 主节点API ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-01-23T15:48:39.000Z"}],["meta",{"property":"article:author","content":"LincDocs"}],["meta",{"property":"article:modified_time","content":"2025-01-23T15:48:39.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"自动部署k3s集群\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-01-23T15:48:39.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"LincDocs\\",\\"url\\":\\"https://github.com/LincDocs/MdNote_Public/\\"}]}"]]},"headers":[{"level":1,"title":"自动部署k3s集群","slug":"自动部署k3s集群","link":"#自动部署k3s集群","children":[{"level":3,"title":"1.集群规划","slug":"_1-集群规划","link":"#_1-集群规划","children":[]},{"level":3,"title":"2.Vagrantfile 配置文件","slug":"_2-vagrantfile-配置文件","link":"#_2-vagrantfile-配置文件","children":[]},{"level":3,"title":"3.安装脚本","slug":"_3-安装脚本","link":"#_3-安装脚本","children":[{"level":4,"title":"环境变量","slug":"环境变量","link":"#环境变量","children":[]},{"level":4,"title":"Flannel网络","slug":"flannel网络","link":"#flannel网络","children":[]}]},{"level":2,"title":"评论补充","slug":"评论补充","link":"#评论补充","children":[]}]}],"git":{"createdTime":1737647319000,"updatedTime":1737647319000,"contributors":[{"name":"Linc","email":"762699299@qq.com","commits":1}]},"readingTime":{"minutes":1.8,"words":540},"filePathRelative":"01. DesignAndDevelop/Virtual/虚拟机/Vagrant/《Vagrant快速入门》/08. 自动部署k3s集群.md","localizedDate":"2025年1月23日","excerpt":"\\n<ul>\\n<li><strong>一行命令</strong></li>\\n<li><strong>自动配置集群</strong></li>\\n<li><strong>全程无需人工干预</strong></li>\\n</ul>\\n<h3>1.集群规划</h3>\\n<table>\\n<thead>\\n<tr>\\n<th>主机名</th>\\n<th>IP地址</th>\\n<th>类型</th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>k3s-server</td>\\n<td>192.168.56.10</td>\\n<td>Control Plane 控制平面</td>\\n</tr>\\n<tr>\\n<td>k3s-agent1</td>\\n<td>192.168.56.11</td>\\n<td>工作节点</td>\\n</tr>\\n<tr>\\n<td>k3s-agent2</td>\\n<td>192.168.56.12</td>\\n<td>工作节点</td>\\n</tr>\\n</tbody>\\n</table>","autoDesc":true,"bioChainData":{"outlink":[],"backlink":[],"localMap":{"nodes":[{"id":"01. DesignAndDevelop/Virtual/虚拟机/Vagrant/《Vagrant快速入门》/08. 自动部署k3s集群.md","value":{"title":"08. 自动部署k3s集群","path":"01. DesignAndDevelop/Virtual/虚拟机/Vagrant/《Vagrant快速入门》/08. 自动部署k3s集群.md","outlink":[],"backlink":[]}}],"links":[]}}}');export{i as comp,r as data};
