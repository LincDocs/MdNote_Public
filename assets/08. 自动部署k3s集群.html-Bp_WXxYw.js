import{_ as i,c as a,f as n,o as l}from"./app-C1kY2qtI.js";const t={};function h(k,s){return l(),a("div",null,s[0]||(s[0]=[n(`<h1 id="自动部署k3s集群" tabindex="-1"><a class="header-anchor" href="#自动部署k3s集群"><span>自动部署k3s集群</span></a></h1><ul><li><strong>一行命令</strong></li><li><strong>自动配置集群</strong></li><li><strong>全程无需人工干预</strong></li></ul><h3 id="_1-集群规划" tabindex="-1"><a class="header-anchor" href="#_1-集群规划"><span>1.集群规划</span></a></h3><table><thead><tr><th>主机名</th><th>IP地址</th><th>类型</th></tr></thead><tbody><tr><td>k3s-server</td><td>192.168.56.10</td><td>Control Plane 控制平面</td></tr><tr><td>k3s-agent1</td><td>192.168.56.11</td><td>工作节点</td></tr><tr><td>k3s-agent2</td><td>192.168.56.12</td><td>工作节点</td></tr></tbody></table><h3 id="_2-vagrantfile-配置文件" tabindex="-1"><a class="header-anchor" href="#_2-vagrantfile-配置文件"><span>2.Vagrantfile 配置文件</span></a></h3><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">vm_list</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  { # hash </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">map</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;name&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> =&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;k3s-server&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;cpu&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> =&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;2&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;mem&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> =&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;2048&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;ip_addr&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> =&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;192.168.56.10&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  },</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  {</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;name&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> =&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;k3s-agent1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;cpu&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> =&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;mem&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> =&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;1024&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;ip_addr&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> =&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;192.168.56.11&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  },</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  {</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;name&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> =&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;k3s-agent2&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;cpu&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> =&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;1&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;mem&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> =&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;1024&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    &quot;ip_addr&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> =&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;192.168.56.12&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Vagrant.configure(2) do |config|</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">   config.vm.box = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;ubuntu/jammy64&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">   vm_list.each do |item|</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        config.vm.define item[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;name&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">] do |node|</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">            node.vm.provider </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;virtualbox&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> do |vbox|</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">              vbox.name = item[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;name&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">];  #虚拟机名称</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">              vbox.memory = item[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;mem&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">]; #内存</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">              vbox.cpus = item[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cpu&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">];   #CPU</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">            end</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">            # 设置hostname</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">            node.vm.hostname = item[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;name&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">            # 设置IP</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">            node.vm.network </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;private_network&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ip</span><span style="--shiki-light:#0184BC;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;ip_addr&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            # </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">执行shell脚本</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">            node</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">vm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E06C75;">provision</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;shell&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> do</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> |</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">script</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">|</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">              script</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;k3s-install.sh&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   #</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">脚本路径</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">              script</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] ]   #</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">传递参数</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">            end</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        end</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">end</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-安装脚本" tabindex="-1"><a class="header-anchor" href="#_3-安装脚本"><span>3.安装脚本</span></a></h3><p>在安装脚本中，我们通过传入的参数，也就是虚拟机的名字，来执行不同的命令。</p><h4 id="环境变量" tabindex="-1"><a class="header-anchor" href="#环境变量"><span>环境变量</span></a></h4><p>自动创建K3s集群，需要配置下面两个环境变量：</p><ul><li><code>K3S_TOKEN</code>： 预先约定好token，工作节点自动加入</li><li><code>K3S_URL</code>： 主节点API server的访问地址</li></ul><p>由于预先分配了IP，所以可以确定API server的访问地址。</p><h4 id="flannel网络" tabindex="-1"><a class="header-anchor" href="#flannel网络"><span>Flannel网络</span></a></h4><p>K3s内置了 <code>flannel</code> 作为默认的网络插件(CNI)。</p><p><code>flannel</code> 默认是选择第一个网卡进行网络通信，由于Vagrant虚拟机的第一个网卡是NAT模式，虚拟机之间无法互相访问。因此，在安装k3s时，需要使用 <code>--flannel-iface</code> 将第二个网卡 <code>enp0s8</code> 设置为默认网络。</p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;==&gt; k3s cluster settings:&quot;</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">K3S_TOKEN</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">NEIwQ0IxMEUtNTA2MS00RE</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">K3S_URL</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">https</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//192.168.56.10:6443</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">FLANNEL_IFACE</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;enp0s8&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;    TOKEN: \${TOKEN}&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;    API_SERVER:\${API_SERVER}&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;    FLANNEL_IFACE:\${FLANNEL_IFACE}&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;==&gt; disable firewall&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">ufw</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> disable</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">$1</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;k3s-server&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">then</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;==&gt; install $1&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    curl</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">sfL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> https</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//rancher-mirror.rancher.cn/k3s/k3s-install.sh | \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">         INSTALL_K3S_MIRROR</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">cn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">         K3S_TOKEN</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">$</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">TOKEN</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} \\</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">         sh</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">s</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> server</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> --</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">flannel</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">iface</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> $</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">FLANNEL_IFACE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;==&gt; install $1&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    curl</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">sfL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> https</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//rancher-mirror.rancher.cn/k3s/k3s-install.sh | \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">         INSTALL_K3S_MIRROR</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">cn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">         K3S_URL</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">https</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//\${API_SERVER}:6443 \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">         K3S_TOKEN</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">$</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">TOKEN</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} \\</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">         sh</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">s</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> --</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">flannel</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">iface</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> $</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">FLANNEL_IFACE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">fi</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="评论补充" tabindex="-1"><a class="header-anchor" href="#评论补充"><span>评论补充</span></a></h2><p>这段脚本中变量有点错误，修改后可用的：</p><div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" data-title="js" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;==&gt; k3s cluster settings:&quot;</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">K3S_TOKEN</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">NEIwQ0IxMEUtNTA2MS00RE</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">K3S_URL</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">https</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//192.168.56.10:6443</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">FLANNEL_IFACE</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;enp0s8&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;    TOKEN: \${K3S_TOKEN}&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;    API_SERVER: \${K3S_URL}&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;    FLANNEL_IFACE: \${FLANNEL_IFACE}&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;==&gt; disable firewall&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">ufw</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> disable</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [ </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">$1</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;k3s-server&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ]; </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">then</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;==&gt; install $1&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    curl</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">sfL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> https</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//rancher-mirror.rancher.cn/k3s/k3s-install.sh | \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">         INSTALL_K3S_MIRROR</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">cn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">         K3S_TOKEN</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">$</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">K3S_TOKEN</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} \\</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">         sh</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">s</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> server</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> --</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">flannel</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">iface</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> $</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">FLANNEL_IFACE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    echo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;==&gt; install $1&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    curl</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">sfL</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> https</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//rancher-mirror.rancher.cn/k3s/k3s-install.sh | \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">         INSTALL_K3S_MIRROR</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">cn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">         K3S_URL</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">$</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">K3S_URL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">         K3S_TOKEN</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">$</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">K3S_TOKEN</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} \\</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">         sh</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">s</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> --</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">flannel</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">iface</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> $</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span><span style="--shiki-light:#986801;--shiki-dark:#E5C07B;">FLANNEL_IFACE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">fi</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,19)]))}const p=i(t,[["render",h],["__file","08. 自动部署k3s集群.html.vue"]]),d=JSON.parse('{"path":"/01.%20DesignAndDevelop/Virtual/%E8%99%9A%E6%8B%9F%E6%9C%BA/Vagrant/%E3%80%8AVagrant%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%8B/08.%20%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2k3s%E9%9B%86%E7%BE%A4.html","title":"自动部署k3s集群","lang":"zh-CN","frontmatter":{"description":"自动部署k3s集群 一行命令 自动配置集群 全程无需人工干预 1.集群规划 2.Vagrantfile 配置文件 3.安装脚本 在安装脚本中，我们通过传入的参数，也就是虚拟机的名字，来执行不同的命令。 环境变量 自动创建K3s集群，需要配置下面两个环境变量： K3S_TOKEN： 预先约定好token，工作节点自动加入 K3S_URL： 主节点API ...","head":[["meta",{"property":"og:url","content":"https://LincDocs.github.io/MdNote_Public/01.%20DesignAndDevelop/Virtual/%E8%99%9A%E6%8B%9F%E6%9C%BA/Vagrant/%E3%80%8AVagrant%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E3%80%8B/08.%20%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2k3s%E9%9B%86%E7%BE%A4.html"}],["meta",{"property":"og:site_name","content":"MdNote_Public"}],["meta",{"property":"og:title","content":"自动部署k3s集群"}],["meta",{"property":"og:description","content":"自动部署k3s集群 一行命令 自动配置集群 全程无需人工干预 1.集群规划 2.Vagrantfile 配置文件 3.安装脚本 在安装脚本中，我们通过传入的参数，也就是虚拟机的名字，来执行不同的命令。 环境变量 自动创建K3s集群，需要配置下面两个环境变量： K3S_TOKEN： 预先约定好token，工作节点自动加入 K3S_URL： 主节点API ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-02-05T15:34:38.000Z"}],["meta",{"property":"article:modified_time","content":"2025-02-05T15:34:38.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"自动部署k3s集群\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-02-05T15:34:38.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"LincDocs\\",\\"url\\":\\"https://github.com/LincDocs/MdNote_Public/\\"}]}"]]},"headers":[{"level":1,"title":"自动部署k3s集群","slug":"自动部署k3s集群","link":"#自动部署k3s集群","children":[{"level":3,"title":"1.集群规划","slug":"_1-集群规划","link":"#_1-集群规划","children":[]},{"level":3,"title":"2.Vagrantfile 配置文件","slug":"_2-vagrantfile-配置文件","link":"#_2-vagrantfile-配置文件","children":[]},{"level":3,"title":"3.安装脚本","slug":"_3-安装脚本","link":"#_3-安装脚本","children":[{"level":4,"title":"环境变量","slug":"环境变量","link":"#环境变量","children":[]},{"level":4,"title":"Flannel网络","slug":"flannel网络","link":"#flannel网络","children":[]}]},{"level":2,"title":"评论补充","slug":"评论补充","link":"#评论补充","children":[]}]}],"git":{"createdTime":1738769678000,"updatedTime":1738769678000,"contributors":[{"name":"Linc","username":"Linc","email":"762699299@qq.com","commits":1,"url":"https://github.com/Linc"}]},"readingTime":{"minutes":1.8,"words":540},"filePathRelative":"01. DesignAndDevelop/Virtual/虚拟机/Vagrant/《Vagrant快速入门》/08. 自动部署k3s集群.md","localizedDate":"2025年2月5日","excerpt":"\\n<ul>\\n<li><strong>一行命令</strong></li>\\n<li><strong>自动配置集群</strong></li>\\n<li><strong>全程无需人工干预</strong></li>\\n</ul>\\n<h3>1.集群规划</h3>\\n<table>\\n<thead>\\n<tr>\\n<th>主机名</th>\\n<th>IP地址</th>\\n<th>类型</th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>k3s-server</td>\\n<td>192.168.56.10</td>\\n<td>Control Plane 控制平面</td>\\n</tr>\\n<tr>\\n<td>k3s-agent1</td>\\n<td>192.168.56.11</td>\\n<td>工作节点</td>\\n</tr>\\n<tr>\\n<td>k3s-agent2</td>\\n<td>192.168.56.12</td>\\n<td>工作节点</td>\\n</tr>\\n</tbody>\\n</table>","autoDesc":true,"bioChainData":{"outlink":[],"backlink":[],"localMap":{"nodes":[{"id":"01. DesignAndDevelop/Virtual/虚拟机/Vagrant/《Vagrant快速入门》/08. 自动部署k3s集群.md","value":{"title":"08. 自动部署k3s集群","path":"01. DesignAndDevelop/Virtual/虚拟机/Vagrant/《Vagrant快速入门》/08. 自动部署k3s集群.md","outlink":[],"backlink":[]}}],"links":[]}}}');export{p as comp,d as data};
